---
apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |
      INSTANCE=$(
        kubectl get statefulset.apps --namespace "${NAMESPACE}" --output name \
          --selector '
            postgres-operator.crunchydata.com/cluster=original,
            postgres-operator.crunchydata.com/instance'
      )

      # Wait for the data to be sent to the WAL archive. A prior step reset the
      # "pg_stat_archiver" counters, so anything more than zero should suffice.
      kubectl exec --namespace "${NAMESPACE}" "${INSTANCE}" \
        -- psql -qb --command '
          DO $$
          BEGIN
            PERFORM pg_switch_wal(); -- at least once
            LOOP
              PERFORM pg_switch_wal() FROM pg_stat_archiver WHERE archived_count = 0;
              EXIT WHEN NOT FOUND;
              PERFORM pg_sleep(1); -- seconds
              ROLLBACK; -- fresh stats
            END LOOP;
          END $$'
