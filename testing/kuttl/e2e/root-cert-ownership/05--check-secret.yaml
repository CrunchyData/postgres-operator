---
apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  # If there are other PostgresClusters in the namespace, ensure that 'owner2'
  # and 'owner2' are not listed.
  # If there are no other PostgresClusters in the namespace, the 'pgo-root-cacert'
  # secret should be deleted.
  - script: |
      NUM_CLUSTERS=$(kubectl --namespace="${NAMESPACE}" get postgrescluster --output name | wc -l)
      if [[ "$NUM_CLUSTERS" != 0 ]]; then
          CURRENT_OWNERS=$(kubectl --namespace="${NAMESPACE}" get secret \
            pgo-root-cacert -o jsonpath='{.metadata.ownerReferences[*].name}')
          if [[ "$CURRENT_OWNERS" == *"owner1"* ]]; then
              exit 1
          fi
          if [[ "$CURRENT_OWNERS" == *"owner2"* ]]; then
              exit 1
          fi
      else
          ROOT_SECRET=$(kubectl --namespace="${NAMESPACE}" get --ignore-not-found \
            secret pgo-root-cacert --output name | wc -l)
          if [[ "$ROOT_SECRET" != 0 ]]; then
              exit 1
          fi
      fi
