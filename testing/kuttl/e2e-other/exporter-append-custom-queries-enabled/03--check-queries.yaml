---
apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |
      set -e
      PRIMARY=$(
        kubectl get pod --namespace "${NAMESPACE}" \
          --output name --selector '
            postgres-operator.crunchydata.com/cluster=exporter-custom-queries,
            postgres-operator.crunchydata.com/role=master'
      )

      # TODO: We have no notion of exporter readiness.
      for _ in $(seq 10); do
        kubectl exec --namespace "${NAMESPACE}" "${PRIMARY}" -c exporter \
          -- curl --head --silent 'http://localhost:9187/metrics' && break
        sleep 1
      done
      
      QUERIES_FILES=$(
        kubectl exec --namespace "${NAMESPACE}" "${PRIMARY}" -c exporter \
          -- ls /conf
      )

      contains() { bash -ceu '[[ "$1" == *"$2"* ]]' - "$@"; }
      {
        contains "${QUERIES_FILES}" "queries.yml" &&
        contains "${QUERIES_FILES}" "defaultQueries.yml"
      } || {
        echo >&2 'The /conf directory should contain queries.yml and defaultQueries.yml. Instead it has:'
        echo "${QUERIES_FILES}"
        exit 1
      }

      MASTER_QUERIES_CONTENTS=$(
        kubectl exec --namespace "${NAMESPACE}" "${PRIMARY}" -c exporter \
          -- cat /tmp/queries.yml
      )

      {
        contains "${MASTER_QUERIES_CONTENTS}" "# This is a test." &&
        contains "${MASTER_QUERIES_CONTENTS}" "ccp_postgresql_version"
      } || {
        echo >&2 'The master queries.yml file should contain the contents of both defaultQueries.yml and the custom queries.yml file. Instead it contains:'
        echo "${MASTER_QUERIES_CONTENTS}"
        exit 1
      }
