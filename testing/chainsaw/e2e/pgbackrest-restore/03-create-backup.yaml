apiVersion: chainsaw.kyverno.io/v1alpha1
kind: StepTemplate
metadata:
  name: 03-create-backup
spec:
  try:
    -
      description: >
        Annotate the cluster to trigger a backup
      patch:
        resource:
          apiVersion: postgres-operator.crunchydata.com/v1beta1
          kind: PostgresCluster
          metadata:
            name: original
            annotations:
              postgres-operator.crunchydata.com/pgbackrest-backup: one

    -
      description: >
        Wait for it to complete
      assert:
        resource:
          apiVersion: batch/v1
          kind: Job
          metadata:
            annotations:
              postgres-operator.crunchydata.com/pgbackrest-backup: one
            labels:
              postgres-operator.crunchydata.com/cluster: original
              postgres-operator.crunchydata.com/pgbackrest-backup: manual
          status:
            succeeded: 1
