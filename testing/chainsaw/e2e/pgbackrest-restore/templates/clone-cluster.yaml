apiVersion: chainsaw.kyverno.io/v1alpha1
kind: StepTemplate
metadata:
  name: clone-cluster
spec:
  bindings:
    - name: name
      value: 'The name of the new PostgresCluster'

  try:
    -
      description: >
        Clone the cluster using a pgBackRest restore
      apply:
        resource:
          apiVersion: postgres-operator.crunchydata.com/v1beta1
          kind: PostgresCluster
          metadata:
            name: ($name)
          spec:
            dataSource:
              postgresCluster:
                clusterName: original
                repoName: repo1
            postgresVersion: ($postgres.version)
            instances:
              - dataVolumeClaimSpec: ($volume)
                tablespaceVolumes:
                  - { name: barn, dataVolumeClaimSpec: ($volume) }
            backups:
              pgbackrest:
                repos:
                  - name: repo1
                    volume:
                      volumeClaimSpec: ($volume)

    -
      description: >
        Wait for the cluster to come online
      assert:
        resource:
          apiVersion: postgres-operator.crunchydata.com/v1beta1
          kind: PostgresCluster
          metadata:
            name: ($name)
          status:
            instances:
              - name: '00'
                replicas: 1
                readyReplicas: 1
                updatedReplicas: 1

  catch:
    - description: Read all log lines from job pods
      podLogs:
        selector: >
          batch.kubernetes.io/job-name,
          postgres-operator.crunchydata.com/cluster in (clone-one)
        tail: -1

    - description: Read all log lines from postgres pods
      podLogs:
        selector: >
          postgres-operator.crunchydata.com/instance,
          postgres-operator.crunchydata.com/cluster in (clone-one)
        tail: -1
