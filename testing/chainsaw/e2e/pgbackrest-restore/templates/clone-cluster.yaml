apiVersion: chainsaw.kyverno.io/v1alpha1
kind: StepTemplate
metadata:
  name: clone-cluster
spec:
  bindings:
    - name: name
      value: 'The name of the new PostgresCluster'

  try:
    -
      description: >
        Clone the cluster using a pgBackRest restore
      apply:
        resource:
          apiVersion: ($postgrescluster.apiVersion)
          kind: PostgresCluster
          metadata:
            name: ($name)
          spec:
            dataSource:
              postgresCluster:
                clusterName: original
                repoName: repo1
            postgresVersion: ($postgres.version)
            instances:
              - dataVolumeClaimSpec: ($volume)
                tablespaceVolumes:
                  - { name: barn, dataVolumeClaimSpec: ($volume) }
            backups:
              pgbackrest:
                repos:
                  - name: repo1
                    volume:
                      volumeClaimSpec: ($volume)

    - description: Wait for PVCs to be created
      sleep:
        duration: 5s

    - description: Check PVC provisioning status early
      script:
        env:
        - name: CLUSTER_NAME
          value: ($name)
        content: |
          echo "=== PVCs for ${CLUSTER_NAME} ==="
          kubectl get pvc -l postgres-operator.crunchydata.com/cluster=${CLUSTER_NAME} -o wide || true
          echo ""
          echo "=== All PVC Events ==="
          kubectl get events --field-selector involvedObject.kind=PersistentVolumeClaim -o wide | tail -20 || true

    -
      description: >
        Wait for the cluster to come online
      assert:
        timeout: 5m
        resource:
          apiVersion: ($postgrescluster.apiVersion)
          kind: PostgresCluster
          metadata:
            name: ($name)
          status:
            instances:
              - name: '00'
                replicas: 1
                readyReplicas: 1
                updatedReplicas: 1

  catch:
    - description: Describe the PostgresCluster to see its status
      describe:
        apiVersion: ($postgrescluster.apiVersion)
        kind: PostgresCluster
        name: ($name)

    - description: Get all pods in the namespace to see what's running
      describe:
        apiVersion: v1
        kind: Pod
        selector: (join('', ['postgres-operator.crunchydata.com/cluster=', $name]))

    - description: Get all jobs to check restore status
      describe:
        apiVersion: batch/v1
        kind: Job
        selector: (join('', ['postgres-operator.crunchydata.com/cluster=', $name]))

    - description: Get events related to the cluster
      script:
        content: kubectl get events --field-selector (join('', ['involvedObject.name=', $name])) -o wide

    - description: Read all log lines from job pods
      podLogs:
        selector: (join('', ['batch.kubernetes.io/job-name,', 'postgres-operator.crunchydata.com/cluster=', $name]))
        tail: -1

    - description: Read all log lines from postgres pods
      podLogs:
        selector: (join('', ['postgres-operator.crunchydata.com/instance,', 'postgres-operator.crunchydata.com/cluster=', $name]))
        tail: -1

    - description: Check PVCs for the cluster
      describe:
        apiVersion: v1
        kind: PersistentVolumeClaim
        selector: (join('', ['postgres-operator.crunchydata.com/cluster=', $name]))

    - description: Get all PVC events to diagnose provisioning failures
      script:
        content: kubectl get events --all-namespaces --field-selector involvedObject.kind=PersistentVolumeClaim -o wide

    - description: Check storage provisioner status
      script:
        content: |
          echo "=== Storage Classes ==="
          kubectl get storageclass -o wide
          echo ""
          echo "=== Local Path Provisioner Pods ==="
          kubectl get pods -n kube-system -l app=local-path-provisioner -o wide
          echo ""
          echo "=== Local Path Provisioner Logs ==="
          kubectl logs -n kube-system -l app=local-path-provisioner --tail=100 --prefix=true

    - description: Check node resources and disk space
      script:
        content: |
          echo "=== Node Resources ==="
          kubectl describe nodes
          echo ""
          echo "=== Node Disk Usage (via docker) ==="
          docker exec k3d-k3s-default-server-0 df -h

    - description: Check all PVs and their status
      script:
        content: kubectl get pv -o wide

    - description: Check for stuck PVCs across all namespaces
      script:
        content: kubectl get pvc --all-namespaces -o wide
