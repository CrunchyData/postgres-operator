apiVersion: chainsaw.kyverno.io/v1alpha1
kind: StepTemplate
metadata:
  name: 12-update-data
spec:
  try:
    -
      description: >
        Add more data to the WAL archive
      apply:
        resource:
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: original-more-data
          spec:
            backoffLimit: 3
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: psql
                    image: ($psql.image)
                    env:
                      - ($psql.connect)
                      - name: PGURI
                        valueFrom: { secretKeyRef: { name: original-pguser-original, key: uri } }

                    command:
                      - psql
                      - $(PGURI)
                      - --set=ON_ERROR_STOP=1
                      - --command
                      - |
                        INSERT INTO important (data) VALUES ('water'), ('socks');

    - assert:
        resource:
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: original-more-data
          status:
            succeeded: 1

    -
      description: >
        Wait for the data to be sent to the WAL archive
      script:
        skipCommandOutput: true
        content: |
          PRIMARY=$(
            kubectl get pod --namespace "${NAMESPACE}" \
              --output name --selector '
                postgres-operator.crunchydata.com/cluster=original,
                postgres-operator.crunchydata.com/role=master'
          )

          kubectl exec --namespace "${NAMESPACE}" "${PRIMARY}" \
            -- psql --command 'SELECT pg_switch_wal()' --pset footer=off

          # A prior step reset the "pg_stat_archiver" counters, so anything more than zero should suffice.
          while [ 0 = "$(
            kubectl exec --namespace "${NAMESPACE}" "${PRIMARY}" \
              -- psql -qAt --command 'SELECT archived_count FROM pg_stat_archiver'
          )" ]; do sleep 1; done

  catch:
    -
      description: >
        Read all log lines from the job pods
      podLogs:
        selector: batch.kubernetes.io/job-name in (original-more-data)
        tail: -1
