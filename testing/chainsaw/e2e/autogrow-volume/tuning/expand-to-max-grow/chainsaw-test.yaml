# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: expand-to-max-grow
spec:
  description: |
    Create a cluster with a value set for maxGrow.
    Trigger volume expansion by writing to the pgdata volume.
    Check that the volume is expanded but doesn't exceed the max grow size.
    Normally we would grow to 1461Mi, but a maxGrow of 200Mi should limit us to 1174Mi
  timeouts:
    assert: 90s
    exec: 15s
  bindings:
  - name: cluster
    value:
      name: expand-to-max-grow  
  - name: postgres
    value:
      version: ($values.versions.postgres)

  steps:
  - name: Check that volume expansion is enabled on the default storage class
    try:
    - assert:
        resource:
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            annotations:
              storageclass.kubernetes.io/is-default-class: "true"
          allowVolumeExpansion: true

  - name: Create cluster with auto-grow enabled
    try:
    - apply:
        resource:
          apiVersion: postgres-operator.crunchydata.com/v1beta1
          kind: PostgresCluster
          metadata:
            name: ($cluster.name)
          spec:
            postgresVersion: (to_number($postgres.version))
            instances:
              - name: instance1
                dataVolumeClaimSpec:
                  autoGrow: { maxGrow: 200Mi }
                  accessModes: [ ReadWriteOnce]
                  resources:
                    requests: { storage: 1Gi }
                    limits: { storage: 5Gi }
                walVolumeClaimSpec:
                  autoGrow: { maxGrow: 200Mi }
                  accessModes: [ ReadWriteOnce]
                  resources:
                    requests: { storage: 1Gi }
                    limits: { storage: 5Gi }
            backups:
              pgbackrest:
                repos:
                  - name: repo1
                    volume:
                      volumeClaimSpec:
                        autoGrow: { maxGrow: 200Mi }
                        accessModes: [ ReadWriteOnce]
                        resources:
                          requests: { storage: 1Gi }
                          limits: { storage: 5Gi }
                  - name: repo2
                    volume:
                      volumeClaimSpec:
                        autoGrow: { maxGrow: 200Mi }
                        accessModes: [ ReadWriteOnce]
                        resources:
                          requests: { storage: 1Gi }
                          limits: { storage: 5Gi }
    - assert:
        # Allow more time for cluster to start and initial backup to complete
        timeout: 300s
        resource:
          apiVersion: postgres-operator.crunchydata.com/v1beta1
          kind: PostgresCluster
          metadata:
            name: ($cluster.name)
          status:
            instances:
              - name: instance1
                readyReplicas: 1
                replicas: 1
                updatedReplicas: 1
            pgbackrest:
              repoHost:
                apiVersion: apps/v1
                kind: StatefulSet
                ready: true
              repos:
              - bound: true
                name: repo1
                replicaCreateBackupComplete: true
                stanzaCreated: true
              - bound: true
                name: repo2
                stanzaCreated: true
    - assert:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            labels:
              postgres-operator.crunchydata.com/cluster: ($cluster.name)
              postgres-operator.crunchydata.com/instance-set: instance1
              postgres-operator.crunchydata.com/role: pgdata
          spec:
            resources:
              requests: { storage: 1Gi }
          status:
            accessModes: [ ReadWriteOnce ]
            capacity: { storage: 1Gi }
            phase: Bound
    - assert:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            labels:
              postgres-operator.crunchydata.com/cluster: ($cluster.name)
              postgres-operator.crunchydata.com/instance-set: instance1
              postgres-operator.crunchydata.com/role: pgwal
          spec:
            resources:
              requests: { storage: 1Gi }
          status:
            accessModes: [ ReadWriteOnce ]
            capacity: { storage: 1Gi }
            phase: Bound
    - assert:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            labels:
              postgres-operator.crunchydata.com/cluster: ($cluster.name)
              postgres-operator.crunchydata.com/data: pgbackrest
              postgres-operator.crunchydata.com/pgbackrest: ""
              postgres-operator.crunchydata.com/pgbackrest-repo: repo1
              postgres-operator.crunchydata.com/pgbackrest-volume: ""
          spec:
            resources:
              requests: { storage: 1Gi }
          status:
            accessModes: [ ReadWriteOnce ]
            capacity: { storage: 1Gi }
            phase: Bound
    - assert:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            labels:
              postgres-operator.crunchydata.com/cluster: ($cluster.name)
              postgres-operator.crunchydata.com/data: pgbackrest
              postgres-operator.crunchydata.com/pgbackrest: ""
              postgres-operator.crunchydata.com/pgbackrest-repo: repo2
              postgres-operator.crunchydata.com/pgbackrest-volume: ""
          spec:
            resources:
              requests:
                storage: 1Gi
          status:
            accessModes:
            - ReadWriteOnce
            capacity:
              storage: 1Gi
            phase: Bound

  - name: Write to the instance volumes to trigger expansion
    try:
    - script:
        env:
        - name: NAMESPACE
          value: ($namespace)
        - name: SELECTOR
          value: (join(',', ['postgres-operator.crunchydata.com/role=master',(concat('postgres-operator.crunchydata.com/cluster=', $cluster.name))]))
        content: >-
          kubectl get pods
          --namespace="${NAMESPACE}"
          --selector=${SELECTOR}
          --output=jsonpath={.items..metadata.name}
        check:
          (contains($stdout, 'instance1')): true
        outputs:
        - name: PRIMARY_POD_NAME
          value: (trim_space($stdout))
    - script:
        env:
        - name: NAMESPACE
          value: ($namespace)
        - name: PRIMARY_POD_NAME
          value: ($PRIMARY_POD_NAME)
        content: >-
          kubectl exec "${PRIMARY_POD_NAME}"
          --namespace="${NAMESPACE}"
          -- bash -c "dd if=/dev/zero of=/pgdata/testfile.$(date +%s) bs=1M count=800"
    - script:
        env:
        - name: NAMESPACE
          value: ($namespace)
        - name: PRIMARY_POD_NAME
          value: ($PRIMARY_POD_NAME)
        content: >-
          kubectl exec "${PRIMARY_POD_NAME}"
          --namespace="${NAMESPACE}"
          -- bash -c "dd if=/dev/zero of=/pgwal/testfile.$(date +%s) bs=1M count=800"

  - name: Write to the repo volumes to trigger expansion
    try:
    - script:
        env:
          - name: NAMESPACE
            value: ($namespace)
          - name: SELECTOR
            value: (join(',', ['postgres-operator.crunchydata.com/pgbackrest-dedicated',(concat('postgres-operator.crunchydata.com/cluster=', $cluster.name))]))
        content: >-
          kubectl get pods
          --namespace="${NAMESPACE}"
          --output=jsonpath={.items..metadata.name}
          --selector="${SELECTOR}"
        check:
          (contains($stdout, 'repo-host')): true
        outputs:
        - name: REPO_HOST_POD_NAME
          value: (trim_space($stdout))
    - script:
        env:
        - name: NAMESPACE
          value: ($namespace)
        - name: REPO_HOST_POD_NAME
          value: ($REPO_HOST_POD_NAME)
        content: >-
          kubectl exec "${REPO_HOST_POD_NAME}"
          --namespace="${NAMESPACE}"
          -- bash -c "dd if=/dev/zero of=/pgbackrest/repo1/testfile.$(date +%s) bs=1M count=800"
    - script:
        env:
        - name: NAMESPACE
          value: ($namespace)
        - name: REPO_HOST_POD_NAME
          value: ($REPO_HOST_POD_NAME)
        content: >-
          kubectl exec "${REPO_HOST_POD_NAME}"
          --namespace="${NAMESPACE}"
          -- bash -c "dd if=/dev/zero of=/pgbackrest/repo2/testfile.$(date +%s) bs=1M count=800"

  - name: Check that volume expansion of max grow size has been requested
    try:
    - assert:
        resource:
          # Check that annotation is set
          apiVersion: v1
          kind: Pod
          metadata:
            labels:
              postgres-operator.crunchydata.com/cluster: ($cluster.name)
              postgres-operator.crunchydata.com/data: postgres
              postgres-operator.crunchydata.com/instance-set: instance1
            annotations:
              suggested-pgdata-pvc-size: 1174Mi
              suggested-pgwal-pvc-size: 1174Mi
    - assert:
        resource:
          apiVersion: v1
          kind: Pod
          metadata:
            labels:
              postgres-operator.crunchydata.com/cluster: ($cluster.name)
              postgres-operator.crunchydata.com/data: pgbackrest
              postgres-operator.crunchydata.com/pgbackrest: ""
              postgres-operator.crunchydata.com/pgbackrest-dedicated: ""
            annotations:
              suggested-repo1-pvc-size: 1174Mi
              suggested-repo2-pvc-size: 1174Mi
            
  - name: Check that the PVCs size requests have been updated
    try:
    - assert:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            labels:
              postgres-operator.crunchydata.com/cluster: ($cluster.name)
              postgres-operator.crunchydata.com/instance-set: instance1
              postgres-operator.crunchydata.com/role: pgdata
          spec:
            resources:
              requests: { storage: 1174Mi }
          status:
            accessModes: [ ReadWriteOnce ]
            capacity: { storage: 2Gi }
            phase: Bound
    - assert:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            labels:
              postgres-operator.crunchydata.com/cluster: ($cluster.name)
              postgres-operator.crunchydata.com/instance-set: instance1
              postgres-operator.crunchydata.com/role: pgwal
          spec:
            resources:
              requests: { storage: 1174Mi }
          status:
            accessModes: [ ReadWriteOnce ]
            capacity: { storage: 2Gi }
            phase: Bound
    - assert:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            labels:
              postgres-operator.crunchydata.com/cluster: ($cluster.name)
              postgres-operator.crunchydata.com/data: pgbackrest
              postgres-operator.crunchydata.com/pgbackrest: ""
              postgres-operator.crunchydata.com/pgbackrest-repo: repo1
              postgres-operator.crunchydata.com/pgbackrest-volume: ""
          spec:
            resources:
              requests:
                storage: 1174Mi
          status:
            accessModes:
            - ReadWriteOnce
            capacity:
              storage: 2Gi
            phase: Bound
    - assert:
        resource:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            labels:
              postgres-operator.crunchydata.com/cluster: ($cluster.name)
              postgres-operator.crunchydata.com/data: pgbackrest
              postgres-operator.crunchydata.com/pgbackrest: ""
              postgres-operator.crunchydata.com/pgbackrest-repo: repo2
              postgres-operator.crunchydata.com/pgbackrest-volume: ""
          spec:
            resources:
              requests:
                storage: 1174Mi
          status:
            accessModes:
            - ReadWriteOnce
            capacity:
              storage: 2Gi
            phase: Bound
  
  - name: Check for VolumeAutoGrow expansion events
    try:
    - script:
        env:
        - name: NAMESPACE
          value: ($namespace)
        - name: FIELD_SELECTOR
          value: (join(',', ['involvedObject.kind=PostgresCluster',(concat('involvedObject.name=', $cluster.name)),'reason=VolumeAutoGrow']))
        content: >-
          kubectl get events
          --namespace="${NAMESPACE}"
          --field-selector="${FIELD_SELECTOR}"
          --output=jsonpath={.items}
        check:
          (parse_json($stdout)[?type == 'Warning']):
          - (contains("message", 'pgWAL volume expansion to 1174Mi requested')): true
          (parse_json($stdout)[?type == 'Normal']):
          - (contains("message", 'pgData volume expansion to 1174Mi requested')): true
          - (contains("message", 'repo1 volume expansion to 1174Mi requested')): true
          - (contains("message", 'repo2 volume expansion to 1174Mi requested')): true
